#!/bin/sh

PAC=(-Syu --noconfirm --needed)
AUR=(-Axu --noconfirm --needed)

echo "-----> starting the update ðŸ˜Ž"

if [[ ! $(command -v aura) ]]
then
    sudo pacman "${PAC[@]}" curl

    echo "Installing Aura"
    cd /tmp
    curl https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=aura-bin > PKGBUILD
    makepkg
    echo Y | sudo pacman -U aura-bin/aura-bin*.tar.xz
    cd -
fi

# xorg and graphical stuff to boot X
PAC+=(xorg-server)                     # xorg-server
PAC+=(xorg-xinit)                      # xorg-xinit
PAC+=(xorg-xrdb)                       # xorg-xrdb
PAC+=(xorg-xmodmap)                    # xorg-xmodmap
PAC+=(xf86-input-libinput)             # xf86-input-libinput
PAC+=(xorg-server-xephyr)              # helps testing lightdm on X
PAC+=(lightdm)                         # lightdm
PAC+=(lightdm-gtk-greeter)             # lightdm-gtk-greeter
PAC+=(accountsservice)                 # accountsservice

# required base software
PAC+=(systemd)                         # systemd
PAC+=(ntp)                             # keep date and time in sync

# kernel flavors
PAC+=(linux-zen)                       # linux-zen
PAC+=(linux-zen-headers)               # linux-zen-headers
PAC+=(linux-headers)                   # linux-headers

# fonts
PAC+=(ttf-dejavu)                      # ttf-dejavu
PAC+=(terminus-font)                   # terminus-font
PAC+=(noto-fonts-cjk)                  # noto-fonts-cjk
PAC+=(noto-fonts-emoji)                # noto-fonts-emoji
PAC+=(xorg-fonts-misc)                 # xorg-fonts-misc
PAC+=(ttf-nerd-fonts-symbols)          # ttf-nerd-fonts-symbols
AUR+=(ttf-font-awesome-4)              # ttf-font-awesome-4

# wireless packages
PAC+=(wpa_supplicant)                  # wpa_supplicant
PAC+=(netctl)                          # netctl
PAC+=(networkmanager)                  # networkmanager
PAC+=(network-manager-applet)          # network-manager-applet

# basic sound packages
PAC+=(pulseaudio)                      # pulseaudio
PAC+=(pavucontrol)                     # pavucontrol
PAC+=(alsa-utils)                      # alsa-utils

# development tools
PAC+=(base-devel)                      # compilers and stuff
PAC+=(git)                             # git
PAC+=(jq)                              # parse json from the command line
PAC+=(tmux)                            # multiple terminals in one tab
AUR+=(ngrok)                           # expose the local env to the internetz
AUR+=(android-sdk-platform-tools)      # adb + fastboot to play with android roms
AUR+=(wakatime)                        # wakatime
AUR+=(heroku-cli)                      # heroku-cli
PAC+=(flake8)                          # python syntax checker
PAC+=(docker)                          # docker
PAC+=(docker-compose)                  # docker-compose

# terminal enhancements
PAC+=(bash-completion)                 # bash-completion
AUR+=(starship)                        # shell line

# image apps
PAC+=(imagemagick)                     # low level image manipulation
PAC+=(gimp)                            # image manipulation
PAC+=(inkscape)                        # vector drawing
PAC+=(shotwell)                        # photo management
PAC+=(peek)                            # gif generator

# audio/video apps
PAC+=(vlc)                             # video player
PAC+=(obs-studio)                      # video recording and streaming
PAC+=(audacity)                        # audio mixer

# utilitaries
PAC+=(xsel)                            # add data to clipboard via command line
PAC+=(unzip)                           # extract .zip files
PAC+=(unrar)                           # extract .rar files
PAC+=(gnome-calculator)                # default calculator for gnome
PAC+=(xournalpp)                       # annotate PDFs
PAC+=(hugo)                            # static pagde generator
PAC+=(texlive-bin)                     # compile TeX files
PAC+=(dos2unix)                        # convert files from windows to Linux format

# rust alternative to common commands
PAC+=(exa)                             # alternative to ls
PAC+=(ripgrep)                         # alternative to grep
PAC+=(bat)                             # alternative to cat
PAC+=(fd)                              # alternative to find
PAC+=(sd)                              # alternative to sed

# languages and language managers
PAC+=(python)                          # system version of python (dep for packages)
PAC+=(python2)                         # system version of python2 (dep for packages)
PAC+=(nodejs)                          # system version of nodejs (dep for packages)
AUR+=(asdf-vm)                         # default way to install programming languages

# editors
PAC+=(emacs)                           # emacs
PAC+=(vim)                             # vim
PAC+=(aspell-pt)                       # pt dictionary
PAC+=(aspell-en)                       # en dictionary

# xfce4
PAC+=(xfce4)                           # xfce4 window manager
PAC+=(xfce4-goodies)                   # xfce4 additional apps
PAC+=(file-roller)                     # archive manager for compressed files
PAC+=(gvfs)                            # network functionality for file managers
AUR+=(sardi-icons)                     # sardi icons
AUR+=(newaita-icons-git)               # newaita icons
AUR+=(xfce4-hardware-monitor-plug)     # xfce4-hardware-monitor-plug
# AUR+=(xfwm-axiom-theme)              # axiomd theme. Not reliable to install via AUR

# i3/sway
PAC+=(i3-wm)                           # i3-wm
PAC+=(i3lock)                          # i3lock
PAC+=(i3status)                        # i3status
PAC+=(i3blocks)                        # i3blocks
PAC+=(sway)                            # sway
PAC+=(rxvt-unicode)                    # rxvt-unicode

# communication
PAC+=(keybase)                         # keybase
AUR+=(telegram-desktop)                # telegram-desktop
AUR+=(zoom)                            # zoom

# file sharing
AUR+=(dropbox)                         # dropbox
AUR+=(gdrive)                          # gdrive

# entretainment software
PAC+=(steam)                           # steam

# browsers
PAC+=(firefox)                         # firefox
PAC+=(chromium)                        # chromium

# productivity related software
PAC+=(redshift)                        # makes the screen red at night
AUR+=(rescuetime2)                     # rescuetime2
AUR+=(toggldesktop)                    # toggldesktop

# networking tools and monitoring software
PAC+=(bandwhich)                       # bandwhich
PAC+=(sysstat)                         # mostly for iostat
PAC+=(openssh)                         # openssh

# laptop improvements (mostly thinkpad specifics)
PAC+=(acpid)                           # acpid
PAC+=(tlp)                             # advanced power management
PAC+=(smartmontools)                   # disk monitoring tool
PAC+=(ethtool)                         # tool to read and modify network interfaces
PAC+=(acpi_call)                       # improve battery usage on thinkpads (recommended by tlp)
PAC+=(throttled)                       # avoid thermal throttling on thinkpad

# install virtualization software
PAC+=(virtualbox)                      # virtualbox
PAC+=(virtualbox-host-modules-arch)    # virtualbox-host-modules-arch
PAC+=(qemu)                            # machine emulator and virtualizer
PAC+=(virt-manager)                    # libvirt + virt-manager

# update all installed packages and install the ones mentioned above
sudo pacman "${PAC[@]}" 2>/dev/null

echo "-----> checking aura packages ðŸ‘»"
sudo aura   "${AUR[@]}" 2>/dev/null

# activate essential services
SVC=(ntpd.service)                     # ntp service
SVC+=(NetworkManager.service)          # network manager service
SVC+=(acpid.service)                   # acpi service
SVC+=(nscd.service)                    # domain name caching service
SVC+=(lightdm.service)                 # login manager service
SVC+=(lenovo_fix.service)              # throttled service
SVC+=(tlp.service)                     # battery optimizing service
SVC+=(libvirtd.service)                # virtualization daemon from libvirt

echo "-----> activating services ðŸ’ª"
sudo systemctl enable "${SVC[@]}"

echo "-----> installing programming languages ðŸ’»"
# install and/or update all programming languages
asdf plugin add elixir
asdf plugin add golang
asdf plugin add nodejs
asdf plugin add python
asdf plugin add ruby
asdf plugin add rust

asdf plugin update --all

LATEST_ELIXIR=$(asdf list all elixir | rg "^\d+\.\d+\.\d+-otp.*$" | tail -n 1)
LATEST_GOLANG=$(asdf list all golang | rg "^\d+\.\d+\.\d+$" | tail -n 1)
LATEST_NODEJS=$(asdf list all nodejs | rg "^\d+\.\d+\.\d+$" | tail -n 1)
LATEST_PYTHON=$(asdf list all python | rg "^\d+\.\d+\.\d+$" | tail -n 1)
LATEST_RUBY=$(asdf list all ruby | rg "^\d+\.\d+\.\d+$" | tail -n 1)

asdf install elixir $LATEST_ELIXIR
asdf global elixir $LATEST_ELIXIR

asdf install golang $LATEST_GOLANG
asdf global golang $LATEST_GOLANG

sh ~/.asdf/plugins/nodejs/bin/import-release-team-keyring 2>/dev/null
asdf install nodejs $LATEST_NODEJS
asdf global nodejs $LATEST_NODEJS

asdf install python $LATEST_PYTHON
asdf global python $LATEST_PYTHON

asdf install ruby $LATEST_RUBY
asdf global ruby $LATEST_RUBY

asdf install rust stable
asdf install rust nightly
asdf global rust nightly
cargo +nightly install racer -q

echo "-----> done! âœ¨"
exit 0
